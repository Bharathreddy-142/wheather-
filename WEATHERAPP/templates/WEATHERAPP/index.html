{% extends 'WEATHERAPP/base.html' %}
{% load weather_filters %}

{% block title %}Weather Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-8 mx-auto">
        <h1 class="mb-4">Weather Dashboard</h1>
        
        <!-- Search Form -->
        <div class="form-container">
            <h5 class="mb-3">Search Weather by City</h5>
            <form method="post" action="{% url 'weather_index' %}" class="mb-4">
                {% csrf_token %}
                <div class="input-group">
                    {{ search_form.city_name }}
                    <button class="btn btn-primary" type="submit" name="search">
                        üîç Search
                    </button>
                </div>
            </form>
        </div>

        <!-- Recent Searches -->
        {% if recent_searches %}
            <h5 class="text-white mb-3">üîç Recent Searches</h5>
            <div class="row">
                {% for search_record in recent_searches %}
                    {% with weather=weather_data|dict_lookup:search_record.city.id %}
                    <div class="col-md-6">
                        <div class="weather-card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="{% url 'weather_city_detail' search_record.city.id %}" class="text-decoration-none">
                                        {{ search_record.city.name }}, {{ search_record.city.country }}
                                    </a>
                                </h5>
                                <small class="text-muted d-block mb-2">Searched: {{ search_record.searched_at|date:"M d, Y H:i" }}</small>
                                
                                {% if weather %}
                                    <div class="weather-icon">
                                        {% if weather.main == 'Clear' %}
                                            ‚òÄÔ∏è
                                        {% elif weather.main == 'Clouds' %}
                                            ‚òÅÔ∏è
                                        {% elif weather.main == 'Rain' %}
                                            üåßÔ∏è
                                        {% elif weather.main == 'Thunderstorm' %}
                                            ‚õàÔ∏è
                                        {% elif weather.main == 'Snow' %}
                                            ‚ùÑÔ∏è
                                        {% else %}
                                            üå§Ô∏è
                                        {% endif %}
                                    </div>
                                    
                                    <div class="temp-display">
                                        {{ weather.temperature|floatformat:1 }}¬∞C
                                    </div>
                                    
                                    <p class="text-muted mb-3">{{ weather.description }}</p>
                                    
                                    <div class="weather-info">
                                        <div class="info-item">
                                            <div class="info-label">Feels Like</div>
                                            <div class="info-value">{{ weather.feels_like|floatformat:1 }}¬∞C</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Min/Max</div>
                                            <div class="info-value">{{ weather.temp_min|floatformat:1 }}¬∞ / {{ weather.temp_max|floatformat:1 }}¬∞C</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Humidity</div>
                                            <div class="info-value">{{ weather.humidity }}%</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Pressure</div>
                                            <div class="info-value">{{ weather.pressure }} hPa</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Wind Speed</div>
                                            <div class="info-value">{{ weather.wind_speed|floatformat:1 }} m/s</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Cloudiness</div>
                                            <div class="info-value">{{ weather.cloudiness }}%</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 d-flex gap-2">
                                        <a href="{% url 'weather_refresh' search_record.city.id %}" class="btn btn-sm btn-info">üîÑ Refresh</a>
                                        <a href="{% url 'weather_city_detail' search_record.city.id %}" class="btn btn-sm btn-primary">üìä Full Report</a>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning" role="alert">
                                        Unable to fetch weather data.
                                    </div>
                                    <div class="mt-3 d-flex gap-2">
                                        <a href="{% url 'weather_refresh' search_record.city.id %}" class="btn btn-sm btn-info">üîÑ Retry</a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>No search history yet!</strong> Search for a city above to get started.
            </div>
        {% endif %}
    </div>
</div>

<!-- Setup Instructions -->
<div class="row mt-5">
    <div class="col-lg-8 mx-auto">
        <div class="form-container">
            <h5>‚öôÔ∏è How to Use</h5>
            <ol>
                <li>Enter a city name in the search box above</li>
                <li>Click "Search" to view the full weather report</li>
                <li>Your searches will appear here in recent searches</li>
                <li>Click "Full Report" for detailed weather information</li>
                <li>View all searches in <a href="{% url 'search_history' %}">Search History</a></li>
            </ol>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Enhanced animations with JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // Ripple effect on buttons
        const buttons = document.querySelectorAll('.btn-primary, .btn-info');
        buttons.forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.className = 'ripple-effect';
                
                this.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            });
        });

        // Animated number counters
        const infoValues = document.querySelectorAll('.info-value');
        infoValues.forEach(element => {
            const text = element.textContent;
            const number = parseFloat(text);
            
            if (!isNaN(number) && text.includes('¬∞')) {
                element.style.transition = 'all 0.3s ease';
            }
        });

        // Add class to trigger animations
        const weatherCards = document.querySelectorAll('.weather-card');
        weatherCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            
            // Add subtle tilt on hover
            card.addEventListener('mouseenter', function() {
                const rect = this.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = (y - centerY) / 10;
                const rotateY = (centerX - x) / 10;
                
                this.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-10px)`;
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) translateY(0)';
            });
        });

        // Smooth scroll to elements
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Animate info items on card hover
        weatherCards.forEach(card => {
            const infoItems = card.querySelectorAll('.info-item');
            card.addEventListener('mouseenter', function() {
                infoItems.forEach((item, index) => {
                    item.style.animation = `none`;
                    setTimeout(() => {
                        item.style.animation = `fadeInUp 0.3s ease-out ${index * 0.05}s forwards`;
                    }, 10);
                });
            });
        });

        // Parallax effect on mouse move
        document.addEventListener('mousemove', function(e) {
            const weatherCards = document.querySelectorAll('.weather-card');
            const x = (e.clientX / window.innerWidth) * 2 - 1;
            const y = (e.clientY / window.innerHeight) * 2 - 1;
            
            weatherCards.forEach(card => {
                const rect = card.getBoundingClientRect();
                // Only apply if card is visible
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    const cardX = rect.left + rect.width / 2;
                    const cardY = rect.top + rect.height / 2;
                    const distance = Math.sqrt(Math.pow(e.clientX - cardX, 2) + Math.pow(e.clientY - cardY, 2));
                    
                    if (distance < 300) {
                        const intensity = (300 - distance) / 100;
                        const moveX = (e.clientX - cardX) / 20 * intensity;
                        const moveY = (e.clientY - cardY) / 20 * intensity;
                        
                        card.style.boxShadow = `0 ${20 + intensity * 10}px ${50 + intensity * 10}px rgba(0, 0, 0, ${0.1 + intensity * 0.1})`;
                    }
                }
            });
        });
    });
</script>

<style>
    /* Ripple effect for buttons */
    .btn-primary, .btn-info {
        position: relative;
        overflow: hidden;
    }

    .ripple-effect {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple 0.6s ease-out;
        pointer-events: none;
    }

    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    /* Enhanced 3D perspective */
    .weather-card {
        transform-style: preserve-3d;
    }

    /* Smooth transitions for all interactive elements */
    button, a, input {
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
</style>
{% endblock %}
